<!DOCTYPE html>
<html layout:decorate="layout" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
    <head>
        <link th:href="@{/css/plugins/jqGrid/ui.jqgrid.css}" rel="stylesheet">
        <link th:href="@{/css/plugins/jQueryUI/jquery-ui-1.10.4.custom.min.css}" rel="stylesheet">
        <script th:src="@{/js/plugins/jqGrid/i18n/grid.locale-en.js}"></script>
        <script th:src="@{/js/jquery-3.1.1.min.js}"></script>
        <script th:src="@{/js/plugins/layer/layer.js}"></script>
        <script th:src="@{/js/bootstrap-table/bootstrap-table.js}"></script>
        <script th:src="@{/js/bootstrap-table/bootstrap-table-zh-CN.js}"></script>
        <script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
        <script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

        <!-- Custom and plugin javascript -->
        <script src="/js/inspinia.js"></script>
        <script src="/js/plugins/pace/pace.min.js"></script>
        <script src="https://cdn.bootcss.com/jquery.serializeJSON/2.8.1/jquery.serializejson.js"></script>
    </head>
    <body>
        <div layout:fragment="content" class="right_col" role="main">
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-lg-10">
                    <h2>需求列表</h2>
                    <ol class="breadcrumb">
                        <li>
                            <a href="index.html">需求管理</a>
                        </li>
                        <li class="active">
                            <strong>需求列表</strong>
                        </li>
                    </ol>
                </div>
            </div>
            <div class="wrapper wrapper-content">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox ">
                            <!--<div class="ibox-title">-->
                                <!--<h5>jQuery Grid Plugin – jqGrid</h5>-->
                            <!--</div>-->
                            <div class="ibox-content">
                                <div class="jqGrid_wrapper">
                                    <table id="test-table" class="table table-hover table-striped table-condensed table-bordered">
                                        <th class="text-left" data-field="action" data-formatter="actionFormatter" data-events="actionEvents">操作</th>
                                    </table>
                                    <div id="toolbar" class="btn-group row" style="margin-top: 10px;margin-bottom: 20px">
                                        <div class="col-sm-12">
                                        <button id="btn_add" type="button" class="btn btn-success" onclick="addShow();">
                                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
                                        </button>
                                        <button id="btn_edit" type="button" class="btn btn-success"
                                                onclick="Show();">
                                            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>显示详情
                                        </button>
                                        <button id="btn_delete" type="button" class="btn btn-success"
                                                onclick="delShow();">
                                            <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>选择删除
                                        </button>
                                        </div>
                                        <div class="col-sm-10" style="margin-top: 15px;padding-left: 0px">
                                            <div class="col-sm-2">
                                                <select id="domainId"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择产业类别</option>
                                                    <option value="01">农业</option>
                                                    <option value="02">工业</option>
                                                    <option value="03">服务业</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <select id="industyId"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择所属行业</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <select id="domainAttr"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择产业属性</option>
                                                    <option value="01">传统优势产业</option>
                                                    <option value="02">战略性新兴产业</option>
                                                    <option value="03">现代化大农产业及绿色食品工业</option>
                                                    <option value="04">生产性服务业</option>
                                                    <option value="05">生活性服务业</option>
                                                    <option value="06">其他性服务业</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <select id="requireAttr"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择需求属性</option>
                                                    <option value="01">科技需求</option>
                                                    <option value="02">人才需求</option>
                                                    <option value="03">培训需求</option>
                                                    <option value="04">规划需求</option>
                                                    <option value="05">综合需求</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <select id="location"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择所属地市</option>
                                                </select>
                                            </div>

                                            <div class="col-sm-2">
                                                <select id="strategy"
                                                        class="selectpicker show-tick form-control">
                                                    <option value="0">请选择所属战略</option>
                                                    <option value="01">辽宁沿海经济带</option>
                                                    <option value="02">沈阳经济区</option>
                                                    <option value="03">突破辽西北</option>
                                                    <option value="04">沈抚新区</option>
                                                    <option value="05">区域经济</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="col-sm-2" style="margin-top: 15px;padding-left: 0px">
                                            <input class="col-sm-6" style="height:34px;" id="searchText" type="text" placeholder="搜索"/>
                                            <button style="border-color: #1c84c5;background-color: #1c84c5;width: 60px" id="queryButton" class="btn"><font style="color: #ffffff">查询</font></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                function constractTable() {
                    $("#test-table").bootstrapTable('destroy');
                    var searchText = $("#searchText").val();
                    var domainId = $("#domainId").val();
                    var industyId = $("#industyId").val();
                    var domainAttr = $("#domainAttr").val();
                    var requireAttr = $("#requireAttr").val();
                    var location = $("#location").val();
                    var strategy = $("#strategy").val();
                    $("#test-table").bootstrapTable({
                        method : 'GET',
                        url: encodeURI("/project/list?searchText=%"+searchText+"%"+"&domainId="+domainId+"&industyId="+industyId
                            +"&domainAttr="+domainAttr+"&requireAttr="+requireAttr+"&location="+location+"&strategy="+strategy),
                        cache : false,
                        striped : true,
                        pagination : true, //在表格底部显示分页工具栏
                        pageSize : 10, //默认每页条数
                        pageNumber : 1, //默认分页
                        toolbar: '#toolbar',
                        pageList : [ 10, 20, 50, 100, 200, 500 ],//分页数
                        showColumns : true, //显示隐藏列
                        showRefresh : false, //显示刷新按钮
                        showExport : true,
                        clickToSelect: true, // 单击行即可以选中
                        search : false,//显示搜素表单
                        silent : false, //刷新事件必须设置
                        sidePagination : "server", //表示服务端请求
                        singleSelect: true, //开启单选
                        editable: true,
                        checkboxHeader: true,
                        columns : [
                            {
                                class : 'col-md-1',
                                checkbox: true
                            },
                            {
                                field : "industry",
                                title : "产业类别",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "location",
                                title : "需求所在地",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "industryName",
                                title : "所属行业",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "industryAttr",
                                title : "产业属性",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "requireAttr",
                                title : "需求属性",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "company",
                                title : "企业名称",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            },
                            {
                                field : "projectName",
                                title : "项目名称",
                                class : 'col-md-1',
                                align : "center",
                                valign : "middle",
                                sortable : "true"
                            }
                        ],
                        queryParamsType: "undefined",
                        queryParams: function queryParams(params) {   //设置查询参数
                            //var x = $("#myId").val();
                            var param = {
                                pageNumber: params.pageNumber,
                                pageSize: params.pageSize,
                                //myId: x,
                                // searchText: params.searchText
                            };
                            return param;
                        },
                        formatLoadingMessage : function() {
                            return "请稍等，正在加载中...";
                        },

                        formatNoMatches : function() {
                            return '无符合条件的记录';
                        },
                        //注册加载子表的事件。注意下这里的三个参数！
                        onExpandRow: function (index, row, $detail) {
                            oInit.InitSubTable(index, row, $detail);
                        }
                    })
                }
                $(document).ready(function () {
                        setTimeout(function () {
                            toastr.options = {
                                closeButton: true,
                                progressBar: true,
                                showMethod: 'slideDown',
                                timeOut: 4000
                            };
                            toastr.success('管理员', '欢迎来到后台管理页面');
                        }, 1300);
                    $.ajax({
                        type: "GET",
                        // async: false,
                        url: "/loadLocation",
                        data: {
                            domainCode:$("#domainId").val(),
                        },
                        dataType: "json",
                        success:function (items) {
                            $("#location").empty();
                            $("#location").append("'<option value='0'>请选择所属地市</option>'");
                            $.each(items,function (i, item) {
                                str =
                                    '<option value="'+item.code+'">' + item.area + '</option>';
                                $("#location").append(str);
                            });
                        }
                    });
                    constractTable();
                });
                function delShow() {
                    var rows = $("#test-table").bootstrapTable('getSelections');
                    layer.open({
                        type: 0,
                        skin: 'layui-layer-rim', //加上边框
                        area: ['420px', '300px'], //宽高
                        content: '是否要删除？',
                        shift: 3,
                        btn: ['确定', '取消'],
                        yes:function(index, layero) {
                            layer.close(index);
                            $.ajax({
                                type: "DELETE",
                                    url: "/project?id="+$("#test-table").bootstrapTable('getSelections')[0].projId,
                                    success:function (data) {
                                        console.log(data);
                                    if(data.status=='success'){
                                        $("#test-table").bootstrapTable('destroy');
                                        constractTable();
                                        setTimeout(function () {
                                            toastr.options = {
                                                closeButton: true,
                                                progressBar: true,
                                                showMethod: 'slideDown',
                                                timeOut: 4000
                                            };
                                            toastr.success('删除成功');
                                        }, 1300);
                                    }
                                    else{
                                        setTimeout(function () {
                                            toastr.options = {
                                                closeButton: true,
                                                progressBar: true,
                                                showMethod: 'slideDown',
                                                timeOut: 4000
                                            };
                                            toastr.error('删除失败');
                                        }, 1300);
                                    }
                                }
                            });
                        },
                        no:function(index, layero) {
                            //点击取消时，弹出框就没了
                        }
                    })
                }
                function addShow(){
                    layer.open({
                        type:2,
                        skin: 'layui-layer-rim', //加上边框
                        area: ['1024px', '728px'], //宽高
                        content: '/required/add',
                        btn: ['确定', '取消'],
                        yes:function(index, layero){
                            $.ajax()
                        }
                    })
                }

                function Show() {
                    var rows = $("#test-table").bootstrapTable('getSelections');
                    layer.open({
                        type: 2,
                        skin: 'layui-layer-rim', //加上边框
                        area: ['1024px', '728px'], //宽高
                        content: '/required?projId='+rows[0].projId,
                        btn: ['需求状态重置', '取消'],
                        yes:function(index, layero) {
                            layer.open({
                                type: 0,
                                skin: 'layui-layer-rim', //加上边框
                                area: ['200px', '150px'], //宽高
                                content:'确定重置需求状态？',
                                btn: ['确定', '取消'],
                                yes:function (index,layero) {
                                    $.ajax({
                                        type: "PATCH",
                                        url: "/require/reset?zxh="+rows[0].zxh,
                                        success:function (data) {
                                            if(data.states=='1'){
                                                setTimeout(function () {
                                                    toastr.options = {
                                                        closeButton: true,
                                                        progressBar: true,
                                                        showMethod: 'slideDown',
                                                        timeOut: 4000
                                                    };
                                                    toastr.success('重置成功');
                                                }, 1300);
                                            }
                                            else{
                                                setTimeout(function () {
                                                    toastr.options = {
                                                        closeButton: true,
                                                        progressBar: true,
                                                        showMethod: 'slideDown',
                                                        timeOut: 4000
                                                    };
                                                    toastr.error('重置失败');
                                                }, 1300);
                                            }
                                        }
                                    });
                                }
                            })
                        },
                        no:function(index, layero) {
                            //点击取消时，弹出框就没了
                        }
                    });
                }
                $("#domainId").change(function () {
                    $.ajax({
                        type: "GET",
                        url: "/loadIndusty",
                        data: {
                            domainCode:$("#domainId").val(),
                        },
                        dataType: "json",
                        success:function (items) {
                            $("#industyId").empty();
                            $("#industyId").append("'<option value='0'>请选择所属行业</option>'");
                            $.each(items,function (i, item) {
                                str =
                                    '<option value="'+item.industyId+'">' + item.industyName + '</option>';
                                $("#industyId").append(str);
                            });
                        }
                    });
                })
                $("#queryButton").click(function () {
                    constractTable();
                })
            </script>
        </div>
    </body>
</html>
